"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.assertPluginManifest = void 0;
const globalContext_1 = require("../../../runtime/globalContext");
// We import from node/utils.ts insead of node/plugin/utils.ts because this file is loaded by the server runtime
const utils_1 = require("../../../../node/utils");
function assertPluginManifest(pluginManifest) {
    (0, utils_1.assert)((0, utils_1.isPlainObject)(pluginManifest));
    (0, utils_1.assertUsage)(pluginManifest.version === utils_1.projectInfo.projectVersion, `You need to re-build your app (\`$ vite build\`). (Because you are using \`vite-plugin-ssr@${utils_1.projectInfo.projectVersion}\` while your build has been generated with a different version \`vite-plugin-ssr@${pluginManifest.version}\`.)`);
    (0, globalContext_1.assertRuntimeManifest)(pluginManifest);
    (0, utils_1.assert)((0, utils_1.hasProp)(pluginManifest, 'usesClientRouter', 'boolean'));
    (0, utils_1.assert)((0, utils_1.hasProp)(pluginManifest, 'version', 'string'));
    (0, utils_1.assert)((0, utils_1.hasProp)(pluginManifest, 'manifestKeyMap', 'object'));
    const { manifestKeyMap } = pluginManifest;
    (0, utils_1.assert)((0, utils_1.isStringRecord)(manifestKeyMap));
    // Avoid:
    // ```
    // Uncaught (in promise) TypeError: Cannot set property manifestKeyMap of #<Object> which has only a getter
    // ```
    // See https://github.com/brillout/vite-plugin-ssr/issues/596
    const pluginManifestClone = { ...pluginManifest };
    (0, utils_1.objectAssign)(pluginManifestClone, { manifestKeyMap });
    (0, utils_1.checkType)(pluginManifestClone);
}
exports.assertPluginManifest = assertPluginManifest;
