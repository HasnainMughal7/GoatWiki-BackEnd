"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getManifestEntry = void 0;
const utils_1 = require("../../../utils");
const assertClientEntryId_1 = require("./assertClientEntryId");
const virtualIdPageCodeFilesImporter_1 = require("../../../commons/virtualIdPageCodeFilesImporter");
function getManifestEntry(id, clientManifest, manifestKeyMap) {
    (0, assertClientEntryId_1.assertClientEntryId)(id);
    // VPS client entry
    if (id.startsWith('@@vite-plugin-ssr/')) {
        const manifestKeyEnd = (0, utils_1.slice)(id, '@@vite-plugin-ssr'.length, 0);
        const { manifestKey, manifestEntry } = findEntryWithKeyEnd(manifestKeyEnd, clientManifest, id);
        (0, utils_1.assert)(manifestEntry && manifestKey, id);
        return { manifestEntry, manifestKey };
    }
    // Code files importer
    if ((0, virtualIdPageCodeFilesImporter_1.isVirutalModulePageCodeFilesImporter)(id)) {
        const manifestKey = id;
        let manifestEntry = clientManifest[manifestKey];
        (0, utils_1.assert)(manifestEntry, id);
        return { manifestEntry, manifestKey };
    }
    // User files
    if (id.startsWith('/')) {
        const manifestKey = id.slice(1);
        let manifestEntry = clientManifest[manifestKey];
        (0, utils_1.assert)(manifestEntry, id);
        return { manifestEntry, manifestKey };
    }
    // extensions[number].pageFilesDist
    if ((0, utils_1.isNpmPackageModule)(id)) {
        const manifestKey = manifestKeyMap[id];
        (0, utils_1.assert)(manifestKey, id);
        const manifestEntry = clientManifest[manifestKey];
        (0, utils_1.assert)(manifestEntry, { id, manifestKey });
        return { manifestEntry, manifestKey };
    }
    // extensions[number].pageFilesSrc
    if (id.startsWith('/node_modules/') || id.startsWith('/../')) {
        let manifestKeyEnd = id.split('/node_modules/').slice(-1)[0];
        (0, utils_1.assert)(manifestKeyEnd, id);
        (0, utils_1.assert)(!manifestKeyEnd.startsWith('/'));
        manifestKeyEnd = '/' + manifestKeyEnd;
        {
            const { manifestEntry, manifestKey } = findEntryWithKeyEnd(manifestKeyEnd, clientManifest, id);
            if (manifestEntry) {
                (0, utils_1.assert)(manifestKey);
                return { manifestEntry, manifestKey };
            }
        }
        {
            (0, utils_1.assert)(manifestKeyEnd.startsWith('/'));
            const dirS = manifestKeyEnd.split('/');
            (0, utils_1.assert)(dirS[0] === '');
            manifestKeyEnd = '/' + dirS.slice(2).join('/');
            (0, utils_1.assert)(manifestKeyEnd.startsWith('/'), id);
        }
        {
            const { manifestEntry, manifestKey } = findEntryWithKeyEnd(manifestKeyEnd, clientManifest, id);
            if (manifestEntry) {
                (0, utils_1.assert)(manifestKey);
                return { manifestEntry, manifestKey };
            }
        }
        (0, utils_1.assert)(false, id);
    }
    (0, utils_1.assert)(false, id);
}
exports.getManifestEntry = getManifestEntry;
function findEntryWithKeyEnd(manifestKeyEnd, clientManifest, id) {
    (0, utils_1.assert)(manifestKeyEnd.startsWith('/'));
    const manifestKeys = [];
    for (const manifestKey in clientManifest) {
        if (manifestKey.endsWith(manifestKeyEnd)) {
            manifestKeys.push(manifestKey);
        }
    }
    const manifestKeysRelative = manifestKeys.filter((k) => k.startsWith('../'));
    (0, utils_1.assert)(manifestKeysRelative.length <= 1, { id });
    const manifestKey = manifestKeysRelative[0] ?? manifestKeys[0] ?? null;
    if (!manifestKey) {
        return { manifestEntry: null, manifestKey: null };
    }
    const manifestEntry = clientManifest[manifestKey];
    return { manifestEntry, manifestKey };
}
