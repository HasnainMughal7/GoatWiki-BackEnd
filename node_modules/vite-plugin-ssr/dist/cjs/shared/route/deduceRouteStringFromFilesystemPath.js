"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.determinePageId2 = exports.determineRouteFromFilesystemPath = exports.deduceRouteStringFromFilesystemPath = void 0;
const utils_1 = require("./utils");
// TODO/next-major-update: remove this and whole filesystemRoot mechanism
function deduceRouteStringFromFilesystemPath(pageId, filesystemRoots) {
    // Handle Filesystem Routing Root
    const filesystemRootsMatch = filesystemRoots
        .filter(({ filesystemRoot }) => pageId.startsWith(filesystemRoot))
        .sort((0, utils_1.higherFirst)(({ filesystemRoot }) => filesystemRoot.length));
    const fsRoot = filesystemRootsMatch[0];
    let filesystemRoute;
    if (fsRoot) {
        // Example values:
        //  - `{"pageId":"/pages/index","filesystemRoot":"/","routeRoot":"/client_portal"}`
        const { filesystemRoot, routeRoot } = fsRoot;
        const debugInfo = { pageId, filesystemRoot, routeRoot };
        (0, utils_1.assert)(routeRoot.startsWith('/') && pageId.startsWith('/') && filesystemRoot.startsWith('/'), debugInfo);
        (0, utils_1.assert)(pageId.startsWith(filesystemRoot), debugInfo);
        if (filesystemRoot !== '/') {
            (0, utils_1.assert)(!filesystemRoot.endsWith('/'), debugInfo);
            filesystemRoute = (0, utils_1.slice)(pageId, filesystemRoot.length, 0);
        }
        else {
            filesystemRoute = pageId;
        }
        (0, utils_1.assert)(filesystemRoute.startsWith('/'), debugInfo);
        filesystemRoute = routeRoot + (routeRoot.endsWith('/') ? '' : '/') + (0, utils_1.slice)(filesystemRoute, 1, 0);
    }
    else {
        filesystemRoute = pageId;
    }
    (0, utils_1.assert)(filesystemRoute.startsWith('/'));
    // Remove `pages/`, `index/, and `src/`, directories
    filesystemRoute = filesystemRoute
        .split('/')
        .filter((dir) => dir !== 'pages' && dir !== 'src' && dir !== 'index')
        .join('/');
    // Hanlde `/index.page.*` suffix
    (0, utils_1.assert)(!filesystemRoute.includes('.page.'));
    (0, utils_1.assert)(!filesystemRoute.endsWith('.'));
    if (filesystemRoute.endsWith('/index')) {
        filesystemRoute = (0, utils_1.slice)(filesystemRoute, 0, -'/index'.length);
    }
    if (filesystemRoute === '') {
        filesystemRoute = '/';
    }
    (0, utils_1.assert)(filesystemRoute.startsWith('/'));
    (0, utils_1.assert)(!filesystemRoute.endsWith('/') || filesystemRoute === '/');
    return filesystemRoute;
}
exports.deduceRouteStringFromFilesystemPath = deduceRouteStringFromFilesystemPath;
// TODO make deduceRouteStringFromFilesystemPath() use determineRouteFromFilesystemPath()
function determineRouteFromFilesystemPath(filesystemPath) {
    const pageId2 = determinePageId2(filesystemPath);
    let routeString = pageId2;
    {
        let paths = routeString.split('/');
        // Remove `pages/`, `index/, and `src/`, directories
        paths = paths.filter((dir) => dir !== 'pages' && dir !== 'src' && dir !== 'index');
        routeString = paths.join('/');
    }
    if (routeString === '') {
        routeString = '/';
    }
    (0, utils_1.assert)(routeString.startsWith('/'));
    (0, utils_1.assert)(!routeString.endsWith('/') || routeString === '/');
    return routeString;
}
exports.determineRouteFromFilesystemPath = determineRouteFromFilesystemPath;
function determinePageId2(filesystemPath) {
    assertFilesystemPath(filesystemPath);
    let paths = filesystemPath.split('/');
    // Remove filename e.g. `+config.js`
    {
        const last = paths[paths.length - 1];
        if (last.includes('.')) {
            paths = paths.slice(0, -1);
        }
    }
    const pageId2 = paths.join('/');
    (0, utils_1.assert)(pageId2.startsWith('/'));
    (0, utils_1.assert)(!pageId2.endsWith('/') ||
        // Unlikely, but may happen
        pageId2 === '/');
    return pageId2;
}
exports.determinePageId2 = determinePageId2;
function assertFilesystemPath(filesystemPath) {
    (0, utils_1.assert)(!filesystemPath.includes('\\'));
    (0, utils_1.assert)(filesystemPath.startsWith('/'));
}
