export { setPageFiles };
export { setPageFilesAsync };
export { getPageFilesAll };
import { assert, unique } from '../utils';
import { parseGlobResults } from './parseGlobResults';
import { getGlobalObject } from '../../utils/getGlobalObject';
const globalObject = getGlobalObject('setPageFiles.ts', {});
function setPageFiles(pageFilesExports) {
    const { pageFiles, pageConfigs } = parseGlobResults(pageFilesExports);
    globalObject.pageFilesAll = pageFiles;
    globalObject.pageConfigs = pageConfigs;
}
function setPageFilesAsync(getPageFilesExports) {
    globalObject.pageFilesGetter = async () => {
        setPageFiles(await getPageFilesExports());
    };
}
async function getPageFilesAll(isClientSide, isProduction) {
    if (isClientSide) {
        assert(!globalObject.pageFilesGetter);
        assert(isProduction === undefined);
    }
    else {
        assert(globalObject.pageFilesGetter);
        assert(typeof isProduction === 'boolean');
        if (!globalObject.pageFilesAll ||
            // We reload all glob imports in dev to make auto-reload work
            !isProduction) {
            await globalObject.pageFilesGetter();
        }
    }
    const { pageFilesAll, pageConfigs } = globalObject;
    assert(pageFilesAll && pageConfigs);
    const allPageIds = getAllPageIds(pageFilesAll, pageConfigs);
    return { pageFilesAll, allPageIds, pageConfigs };
}
function getAllPageIds(allPageFiles, pageConfigs) {
    const fileIds = allPageFiles.filter(({ isDefaultPageFile }) => !isDefaultPageFile).map(({ pageId }) => pageId);
    const allPageIds = unique(fileIds);
    const allPageIds2 = pageConfigs.map((p) => p.pageId2);
    return [...allPageIds, ...allPageIds2];
}
